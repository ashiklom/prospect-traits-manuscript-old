## Sources of trait variability 

```{r setup-methods, echo = FALSE, message = FALSE, warning = FALSE}
library(pta)
library(knitr)
opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
data(global_vars)
```

### Correlations among PROSPECT traits

```{r princomp, fig.cap = princompcap, fig.width = 7, fig.height = 3}
princompcap <- paste('Principal component analysis on all PROSPECT traits')

mypca <- function(dat, char, ...) {
    par_names <- paste('mean', params, '5B', sep = '_')
    names(par_names) <- params
    n_row <- sum(!is.na(dat[['mean_N_5B']]))
    dat %>% 
        select_(.dots = par_names) %>% 
        na.omit() %>% 
        princomp(cor = TRUE) %>% 
        biplot(xlabs = rep(char, n_row), ...)
}

data(results_wide)
data(results_byspecies)
for (i in 1:2) {
    if (i == 2) {
        png(filename = 'figures/pca.png', 
            width = 7, height = 3, units = 'in', res = 300)
    }
    par(mfrow = c(1, 3))
    mypca(results_wide, '.', main = 'All data')
    mypca(results_wide_bysp, 'x', main = 'Species means')
    mypca(results_wide_resid, '.', main = 'Species mean residuals')
    dev.off()
}

```

The within- and across-species relationships between parameters are different.
Across species, there are two orthagonal axes of variability, with the primary axis driven by pigment concentrations and the secondary axis driven by leaf structure (as manifested by contents of brown and dry matter contents, water thickness, and number of mesophyll layers).
Within species, the primary axis of variability is **???**

### Drivers of variability in PROSPECT traits

```{r anovaplot, fig.cap = anovaplot_cap, fig.width = 10, fig.height = 10, eval = FALSE}

anovaplot_cap <- paste('Partitioning variability in PROSPECT traits')

anovadat <- pcaall_dat %>% 
    left_join(tbl(specdb, 'plots') %>% 
              select(sitecode, plotcode) %>% 
              collect) %>% 
    left_join(site_info)

vars <- tribble(
    ~variable, ~color, 
    'leaf_type', 'green4',
    'phenology', 'brown',
    'growth_form', 'purple',
    'myco_asso', 'orange',
    'shade_tolerance', 'yellow',
    'speciescode', 'green1',
    'sitecode', 'red',
    'plotcode', 'cyan')
          
anova_param <- function(dat, param, vars) {
    form <- formula(paste(param, '~', paste(vars, collapse = ' + ')))
    fit <- lm(formula = form, data = dat)
    anova_raw <- anova(fit)
    anova_dat <- anova_raw[, 'Sum Sq', drop = FALSE]
    colnames(anova_dat) <- param
    out <- as_data_frame(anova_dat) %>% rownames_to_column('variable')
    return(list(table = out, fit = fit))
}

anova_list <- lapply(params, function(x) anova_param(anovadat, x, vars$variable))
names(anova_list) <- params

anova_dat <- Reduce((function(...) merge(..., by = 'variable')), 
                    lapply(anova_list, '[[', 'table')) %>%
    gather(parameter, value, -variable) %>%
    mutate(variable = factor(variable, rev(c(vars$variable, 'Residuals'))),
           parameter = factor(parameter, params)) %>%
    group_by(parameter) %>%
    mutate(norm_value = value / sum(value))

ggplot(anova_dat) + 
    aes(x = parameter, y = norm_value, fill = variable) + 
    geom_bar(stat = 'identity') + 
    scale_fill_manual(values = rev(c(vars$color, 'grey')))
    
```

Related to the results above, the primary drivers of variability in PROSPECT traits are trait-dependent.

The number of leaf mesophyll layers, brown matter content, and water thickness are dominated largely by among-species variability.
Much of the among-species variability in the N parameter is explained by leaf type (broad vs. needle), with some additional contribution of shade tolerance.
Leaf type is also important in explaining variability in leaf water content, as is plant growth form.
However, large fractions of this variability are unexplained by any functional attribute, contributing to high residual species-level variability.

Most of the variability in the remaining traits -- pigment and dry matter contents -- is within species, and the majority of that variability remains unexplained.

For all traits, site is an important factor, accounting for approximately 25% of the variance on average.

```{r pftcoefs, fig.cap = pftcoefs_cap, fig.width = 12, fig.height = 12, eval = FALSE}

coeftab <- function(anova_list, param, variable) {
    fit <- anova_list[[param]][['fit']]
    sfit <- summary(fit)
    fitnames <- names(fit$coefficients)
    coef_inds <- grep(variable, fitnames)
    coef_mean <- sfit$coefficients[coef_inds, 'Estimate']
    coef_se <- sfit$coefficients[coef_inds, 'Std. Error'] 
    coeftab <- tibble(parameter = param,
                      variable = variable,
                      varvalue = gsub(variable, '', fitnames[coef_inds]),
                      coef_mean = coef_mean,
                      coef_se = coef_se)
    return(coeftab)
}

coef_list <- list()
coef_vars <- c('leaf_type', 'phenology', 'growth_form',
               'myco_asso', 'shade_tolerance')
i <- 1
for (v in coef_vars) {
    for (p in params) {
        coef_list[[i]] <- coeftab(anova_list, p, v)
        i <- i + 1
    }
}
coeftable <- bind_rows(coef_list) %>%
    mutate(parameter = factor(parameter, params))

ggplot(coeftable) + 
    aes(x = varvalue, y = coef_mean, 
        ymin = coef_mean - coef_se, ymax = coef_mean + coef_se) + 
    geom_pointrange() + 
    geom_hline(yintercept = 0, linetype = 'dashed', color = 'red') +
    facet_grid(parameter ~ variable, scales = 'free')

pftcoefs_cap <- paste('Linear model coefficients, +/- 1 standard error.', 
                      'Baselines are as follows:', 
                      'growth_form = graminoid,',
                      'leaf_type = broad,',
                      'myco_asso = AM,',
                      'phenology = deciduous,',
                      'shade_tolerance = intermediate')

```

Woody species (trees and shrubs) had higher N and lower Cm values than herbaceous species (grasses (zero) and herbs).
Needleleaf species had higher N and lower pigment, brown, and dry matter contents than broadleaf species.
Compared to species with arbuscular (AM, (zero)) mycorrhizal associations, species with ectomycorrhizal associations (EM/ECM) had significantly lower N and higher pigment, brown, and dry matter contents, while the reverse was true of species with erocoid (ERM) mycorrhizal associations.
Evergreen species had higher pigment, brown matter, and dry matter contents and lower N than deciduous species.
Strongly shade tolerant species had significantly higher N and lower pigment, brown matter, and dry matter contents than species with lower shade tolerance.
 
```{r traitsclimate, fig.cap = traitsclimate_cap, fig.width = 12, fig.height = 12, eval = FALSE}

traitsclimate_cap <- paste('Relationship of traits with climate')

traitcli_dat <- anovadat %>%
    select_(.dots = c('samplecode', 'speciescode', 
                      params, 'temp', 'prec')) %>%
    filter(!is.na(temp), !is.na(prec)) %>%
    gather(parameter, value, -samplecode, -temp, -prec, -speciescode) %>%
    gather(climvar, climval, -samplecode, -speciescode, -parameter, -value)

traitcli_plt <- ggplot(traitcli_dat) + 
    aes(x = climval, y = value) + 
    geom_point(color = 'grey50') + 
    geom_smooth(method = 'lm', se = FALSE) +
    facet_wrap(~parameter + climvar, scales = 'free')

plot(traitcli_plt)

```

```{r traitsclimatesp, fig.cap = traitsclimatesp_cap, fig.width = 12, fig.height = 12, eval = FALSE}

traitsclimatesp_cap <- paste('Relationship of traits with climate: ', 
                             'Species means.',
                             'Blue line is a linear fit,',
                             'red line is a quadratic fit.')
traitcli_plt %+% 
    (traitcli_dat %>% 
     group_by(speciescode, parameter, climvar, climval) %>%
     summarize(value = mean(value))) %+%
    stat_smooth(method = 'lm',
                formula = y ~ x + I(x^2),
                color = 'red', se = F)

```

```{r traitsclimateres, fig.cap = traitsclimateres_cap, fig.width = 12, fig.height = 12, eval = FALSE}

traitsclimateres_cap <- paste('Relationship of traits with climate:', 
                              'Normalized residuals from the species mean')
traitcli_plt %+% 
    (traitcli_dat %>% 
     group_by(speciescode, parameter, climvar) %>%
     mutate(value_mean = mean(value, na.rm = TRUE),
            value = (value - value_mean)/value_mean)) + 
    coord_cartesian(ylim = c(-1, 1))

```

Relationships between plant traits and climate occur primarily at the species level, with relatively flat relationships between climate and species mean residuals.
Leaf water thickness and carotenoid, brown matter, and dry matter contents all have a negative relationship with precipitation, while the N parameter and chlorophyll contents have a positive relationship.
All traits have weak positive relationships with temperature, except brown matter content, for which this relationship is strongly negative.

